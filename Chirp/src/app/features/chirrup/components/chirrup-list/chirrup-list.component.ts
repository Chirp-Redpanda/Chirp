import { Component, OnInit, OnDestroy } from '@angular/core';
import { Subscription } from 'rxjs';
import { Chirrup, Comment } from '../../../../core/models/chirrup';
import { ChirrupService } from '../../services/chirrup.service';
import { Profile } from 'src/app/core/models/profile';
import { Message, MessageService } from 'primeng/api';

@Component({
  selector: 'app-chirrup-list',
  templateUrl: './chirrup-list.component.html',
  styleUrls: ['./chirrup-list.component.sass'],
  providers: [MessageService]
})
export class ChirrupListComponent implements OnInit, OnDestroy {
  news: Chirrup[] = [];
  newCommentTexts: { [chirrupId: string]: string } = {};
  user: Profile | undefined;
  private refreshSubscription = new Subscription();

  constructor(
    private chirrupService: ChirrupService,
    private messageService: MessageService
  ) { this.refreshSubscription = new Subscription(); }

  ngOnInit() {
    this.chirrupService.loadChirrups();
    this.refreshSubscription.add(this.chirrupService.news.subscribe(news => {
      this.news = news;
      this.news.forEach(chirrup => {
        this.newCommentTexts[chirrup._id] = '';
      });
    }));
  }

  ngOnDestroy() {
    this.refreshSubscription.unsubscribe();
  }


  toggleHeartIcon(chirrup: Chirrup) {
    chirrup.islike = !chirrup.islike;
    // 因为post service更改了model, 导致这里要handle chirrup._id undefined 的情况,实际上不会有不存在_id的post
    // if current user likes the post, the username is added to the likedIdList
    if (chirrup && chirrup.islike) {
      const likedId = {
          userId: this.user?._id || "", // Ensure it's a string or provide a default value
          _id: chirrup._id || "" // Ensure it's a string or provide a default value
      };
      chirrup.likedIdList.push(likedId);
    }
    // if current user cancel the like, the username is removed from the likedIdList
    else if (chirrup && !chirrup.islike && chirrup.likedIdList){
      const likedId = {
        userId: this.user?._id || "", // Ensure it's a string or provide a default value
        _id: chirrup._id || "" // Ensure it's a string or provide a default value
      };


      chirrup.likedIdList = chirrup.likedIdList.filter(likedId => likedId.userId !== (this.user?._id || ""))
    }

    if (chirrup._id !== undefined) {
      localStorage.setItem(chirrup._id, chirrup.islike.toString());
    } else {
      console.error('chirrup._id is undefined');
    }
  };

  toggleCommentIcon(chirrup: Chirrup) {
    chirrup.showComments = !chirrup.showComments;
  }
  onSubmit(chirrup: Chirrup) {
    const currName = localStorage.getItem('userName');
    const newComment: Comment = {
      _id: '', // This will be generated by the backend
      publisherName: (currName === null) ? '' : currName,
      content: {
        image: '',
        video: '',
        text: this.newCommentTexts[chirrup._id], // Use the bound property for the comment content
        _id: ''
      },
      publishedTime: new Date().toISOString()
    };

    this.chirrupService.addComment(chirrup._id, newComment).subscribe({
      next: _resp => {
        this.newCommentTexts[chirrup._id] = '';  // Clear the input field after adding the comment 
        //alert("you have successfully added a new comment!");
        this.messageService.add({ severity: 'success', summary: 'Comment sent successfully', detail: 'You have added a new comment!', life: 2000 });
      },
      error: _err => {
        console.log("Error posing new comment:", _err);
        this.messageService.add({ severity: 'error', summary: 'Comment failed', detail: 'Please check your Internet connection!', life: 2000 });
      }

    });
  }
}
